name: Deploy Documentation

on:
  workflow_dispatch:
    inputs:
      subfolder:
        description: 'Subfolder for documentation (e.g., docs3, docsv3, docs). Leave empty for root deployment.'
        required: false
        default: ''
        type: string

# Ensure only latest deployment runs
concurrency:
  group: docs-deployment
  cancel-in-progress: true

jobs:
  merge-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          token: ${{ secrets.ORG_GH_TOKEN }}
          fetch-depth: 0  # Fetch all history for all branches

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any additional dependencies if needed

      - name: Read branches config
        id: config
        run: |
          if [ ! -f "branches-config.json" ]; then
            echo "âŒ branches-config.json not found!"
            exit 1
          fi
          echo "âœ… Found branches-config.json"
          cat branches-config.json

      - name: Cleanup everything except preserved files
        run: |
          echo "ğŸ§¹ Cleaning up everything except preserved files..."
          
          # Define files/folders to preserve during cleanup
          preserve_items=(
            ".gitignore"
            ".vale.ini"
            "branches-config.json"
            "README.md"
            ".github"
            ".devcontainer"
            ".vale"
            "scripts"
            ".git"
          )
          
          echo "ğŸ“‹ Files/folders to preserve:"
          printf '%s\n' "${preserve_items[@]}"
          
          # Create temporary backup of preserved items
          echo "ğŸ’¾ Creating temporary backup of preserved items..."
          mkdir -p .temp_backup
          for item in "${preserve_items[@]}"; do
            if [ -e "$item" ]; then
              echo "  ğŸ“¦ Backing up: $item"
              cp -r "$item" .temp_backup/
            fi
          done
          
          # Clean everything (files and directories)
          echo "ğŸ—‘ï¸  Removing all content except preserved items..."
          find . -mindepth 1 -maxdepth 1 ! -name '.temp_backup' -exec rm -rf {} +
          
          # Restore preserved items
          echo "â™»ï¸  Restoring preserved items..."
          if [ -d ".temp_backup" ]; then
            for item in .temp_backup/*; do
              if [ -e "$item" ]; then
                item_name=$(basename "$item")
                echo "  ğŸ“¦ Restoring: $item_name"
                cp -r "$item" .
              fi
            done
            rm -rf .temp_backup
          fi
          
          echo "âœ… Cleanup completed!"
          echo "ğŸ“ Remaining files after cleanup:"
          ls -la | head -10

      - name: Clone and organize branches
        run: |
          set -e
          
          echo "ğŸ”„ Starting branch cloning and organization..."
          
          # Read the branches config and extract branch information
          branches=$(python3 -c "import json; config=json.load(open('branches-config.json')); [print(f\"{v.get('folder','')}:{v.get('branch','main')}\") for v in config.get('versions',[]) if v.get('folder','')]")
          
          echo "ğŸ“‹ Branches to process:"
          echo "$branches"
          
          # Clone each branch into its respective folder
          for branch_info in $branches; do
            if [ -n "$branch_info" ]; then
              folder=$(echo $branch_info | cut -d':' -f1)
              branch=$(echo $branch_info | cut -d':' -f2)
          
              echo "ğŸ“‚ Processing $folder from branch $branch..."
          
              # Remove existing folder if it exists
              if [ -d "$folder" ]; then
                echo "ğŸ—‘ï¸  Removing existing $folder/"
                rm -rf "$folder"
              fi
          
              # Create temporary directory for this branch
              temp_dir="temp_$folder"
          
              # Clone the specific branch
              echo "â¬‡ï¸  Cloning branch $branch into $temp_dir..."
              git clone --single-branch --branch "$branch" --depth 1 \
                "https://github.com/${{ github.repository }}.git" "$temp_dir"
          
              # Move the contents (excluding .git) to the target folder
              mkdir -p "$folder"
              echo "ğŸ“ Moving contents from $temp_dir to $folder..."
          
              # Copy documentation content only, excluding development/build files
              # Excluded: .git, scripts/, branches-config.json, .github/, README.md, .gitignore, .devcontainer/
              find "$temp_dir" -mindepth 1 -maxdepth 1 \
                ! -name '.git' \
                ! -name 'scripts' \
                ! -name 'branches-config.json' \
                ! -name '.github' \
                ! -name 'README.md' \
                ! -name '.gitignore' \
                ! -name '.devcontainer' \
                -exec cp -r {} "$folder/" \;
          
              # Clean up temp directory
              rm -rf "$temp_dir"
          
              echo "âœ… Successfully organized $folder from branch $branch"
          
              # Show what was copied
              echo "ğŸ“‹ Contents of $folder:"
              ls -la "$folder/" | head -10
            fi
          done
          
          echo "ğŸ‰ All branches cloned and organized!"

      - name: Run docs merger
        run: |
          echo "ğŸ”„ Running documentation merger..."
          
          # Handle subfolder parameter properly
          # Distinguish between: no parameter, empty string, and specific value
          if [ -z "${{ github.event.inputs.subfolder }}" ]; then
            # No parameter provided - merge to root (no subfolder)
            USE_SUBFOLDER=false
            echo "ğŸ“ No subfolder parameter provided - merging to root"
          elif [ "${{ github.event.inputs.subfolder }}" = "" ]; then
            # Empty string provided - merge to root (no subfolder)  
            USE_SUBFOLDER=false
            echo "ğŸ“ Empty subfolder parameter provided - merging to root"
          else
            # Specific folder provided - use it
            SUBFOLDER="${{ github.event.inputs.subfolder }}"
            USE_SUBFOLDER=true
            echo "ğŸ“ Using subfolder: $SUBFOLDER"
          fi
          
          # Run the merge script with or without subfolder parameter
          if [ "$USE_SUBFOLDER" = true ]; then
            echo "ğŸ”§ Running merge with subfolder: $SUBFOLDER"
            python3 scripts/merge_docs_configs.py \
              --branches-config branches-config.json \
              --base-dir . \
              --subfolder "$SUBFOLDER" \
              --output docs.json
          else
            echo "ğŸ”§ Running merge to root (no subfolder parameter passed)"
            python3 scripts/merge_docs_configs.py \
              --branches-config branches-config.json \
              --base-dir . \
              --output docs.json
          fi
          
          echo "âœ… Documentation merge completed!"

      - name: Cleanup cloned version folders
        run: |
          echo "ğŸ§¹ Cleaning up temporary cloned version folders..."
          
          # Get current version folders from config
          current_folders=$(python3 -c "import json; config=json.load(open('branches-config.json')); folders=[v.get('folder','') for v in config.get('versions',[]) if v.get('folder','')]; print(' '.join(folders))")
          
          echo "ğŸ“‹ Removing cloned folders: $current_folders"
          
          # Remove the temporary cloned folders (they've been processed into subfolder structure)
          for folder in $current_folders; do
            if [ -n "$folder" ] && [ -d "$folder" ]; then
              echo "ğŸ—‘ï¸  Removing cloned folder: $folder/"
              rm -rf "$folder"
            fi
          done
          
          echo "âœ… Cleanup of cloned folders completed!"

      - name: Verify output
        run: |
          echo "ğŸ“‹ Checking generated files..."
          
          if [ -f "docs.json" ]; then
            echo "âœ… docs.json generated successfully"
            echo "ğŸ“„ docs.json size: $(wc -c < docs.json) bytes"
            echo "ğŸ” First few lines of docs.json:"
            head -20 docs.json
          else
            echo "âŒ docs.json not found!"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“ Generated file structure:"
          find . -name "*.mdx" -o -name "*.md" -o -name "*.json" -o -name "*.css" -o -name "*.png" | head -20

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.ORG_GH_TOKEN }}
          branch: docs-merge-${{ github.run_number }}
          base: production
          title: "ğŸ¤– Auto-merge documentation from branches"
          body: |
            ## ğŸ“š Documentation Merge Summary
            
            This PR contains automatically merged documentation from multiple branches.
            
            **Generated from:** `branches-config.json`  
            **Timestamp:** ${{ github.event.head_commit.timestamp }}  
            **Run ID:** ${{ github.run_id }}
            
            ### Changes Include:
            - âœ… Merged documentation from multiple branches
            - âœ… Generated unified `docs.json` configuration
            - âœ… Updated assets and content structure
            - âœ… Cleaned up outdated version folders
            
            ### Subfolder Used:
            `${{ github.event.inputs.subfolder || 'root (no subfolder)' }}`
            
            ---
            
            Please review the changes and merge when ready.
          commit-message: |
            ğŸ¤– Auto-merge documentation from branches
            
            Generated from branches-config.json at ${{ github.event.head_commit.timestamp }}
            
            - Merged documentation from multiple branches
            - Generated unified docs.json
            - Updated assets and content structure
          delete-branch: true
          draft: false
          maintainer-can-modify: true
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>

      - name: Enable auto-merge on deployment PR
        if: steps.create-pr.outputs.pull-request-number
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          echo "ğŸ”„ Enabling auto-merge on deployment PR #$PR_NUMBER..."
          
          gh pr merge --squash --auto "$PR_NUMBER"
          
          echo "âœ… Auto-merge enabled on PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.ORG_GH_TOKEN }}

      - name: Create deployment summary
        run: |
          echo "## ğŸ“š Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Successfully merged documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs.json\` - Unified configuration" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "docs.json" ]; then
            echo "- Asset files (favicon.png, style.css, images/, etc.)" >> $GITHUB_STEP_SUMMARY
            echo "- Version folders with documentation content" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
